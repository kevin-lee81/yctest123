<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PVC카드 제조 - 주문제작 전문</title>
    <style>
        /* CSS 코드는 제공해주신 원본과 동일합니다 (생략) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; line-height: 1.6; color: #333; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: rgba(255, 255, 255, 0.95); padding: 20px 0; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); backdrop-filter: blur(10px); }
        .header h1 { text-align: center; color: #2c3e50; font-size: 2.5em; margin-bottom: 10px; }
        .header p { text-align: center; color: #7f8c8d; font-size: 1.2em; }
        .nav-buttons { display: flex; justify-content: center; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
        .btn { padding: 12px 30px; border: none; border-radius: 25px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease; text-decoration: none; display: inline-block; }
        .btn-primary { background: linear-gradient(45deg, #3498db, #2980b9); color: white; }
        .btn-secondary { background: linear-gradient(45deg, #e74c3c, #c0392b); color: white; }
        .btn-success { background: linear-gradient(45deg, #27ae60, #229954); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
        .content { background: rgba(255, 255, 255, 0.95); padding: 40px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1); backdrop-filter: blur(10px); margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 16px; transition: border-color 0.3s ease; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #3498db; }
        .hidden { display: none; }
        .business-fields { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 15px; border: 1px solid #e9ecef; }
        .status-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); }
        .status-badge { padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; color: white; }
        .status-pending { background: #f39c12; } .status-processing { background: #3498db; } .status-shipping { background: #9b59b6; } .status-completed { background: #27ae60; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .file-upload-notice { background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ffeaa7; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; color: white; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } .header h1 { font-size: 2em; } .content { padding: 20px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏷️ PVC카드 주문제작</h1>
            <p>프리미엄 PVC카드 전문업체</p>
            <div id="nav-guest" class="nav-buttons">
                <button class="btn btn-primary" onclick="showSection('home')">홈</button>
                <button class="btn btn-secondary" onclick="showSection('login')">로그인</button>
                <button class="btn btn-success" onclick="showSection('register')">회원가입</button>
            </div>
             <div id="nav-user" class="nav-buttons hidden">
                <button class="btn btn-primary" onclick="showDashboardTab('orders')">주문 현황</button>
                <button class="btn btn-secondary" onclick="showDashboardTab('profile')">프로필 수정</button>
                <button class="btn btn-success" onclick="showDashboardTab('newOrder')">새 주문</button>
                <button class="btn btn-primary" onclick="logout()">로그아웃</button>
            </div>
        </div>

        <!-- 홈 섹션 -->
        <div id="home-section" class="content">
            <h2>🎯 주문제작 프로세스</h2>
            <div class="grid-2">
                <div><h3>1️⃣ 회원가입</h3><p>개인 또는 사업자로 가입하여 주문을 시작하세요.</p></div>
                <div><h3>2️⃣ 주문 접수</h3><p>원하는 카드 사양과 수량을 선택하고 주문을 접수합니다.</p></div>
                <div><h3>3️⃣ 디자인 파일 전송</h3><p>주문 완료 후 안내되는 이메일로 디자인 파일을 전송합니다.</p></div>
                <div><h3>4️⃣ 제작 및 배송</h3><p>마이페이지에서 실시간 제작 현황을 확인하고 배송을 기다립니다.</p></div>
            </div>
        </div>

        <!-- 로그인 섹션 -->
        <div id="login-section" class="content hidden">
            <h2>🔐 로그인</h2>
            <div id="login-alert"></div>
            <form id="loginForm">
                <div class="form-group"><label for="loginEmail">이메일</label><input type="email" id="loginEmail" required></div>
                <div class="form-group"><label for="loginPassword">비밀번호</label><input type="password" id="loginPassword" required></div>
                <button type="submit" class="btn btn-primary">로그인</button>
            </form>
        </div>

        <!-- 회원가입 섹션 -->
        <div id="register-section" class="content hidden">
            <h2>📝 회원가입</h2>
            <div id="register-alert"></div>
            <form id="registerForm">
                <div class="form-group"><label for="userType">회원 유형</label><select id="userType" required onchange="toggleBusinessFields()"><option value="">선택하세요</option><option value="individual">개인</option><option value="business">사업자</option></select></div>
                <div class="form-group"><label for="name">이름</label><input type="text" id="name" required></div>
                <div class="form-group"><label for="email">이메일</label><input type="email" id="email" required></div>
                <div class="form-group"><label for="password">비밀번호</label><input type="password" id="password" required></div>
                <div class="form-group"><label for="confirmPassword">비밀번호 확인</label><input type="password" id="confirmPassword" required></div>
                <div class="form-group"><label for="phone">휴대폰 번호</label><input type="tel" id="phone" placeholder="010-0000-0000" required></div>
                <div class="form-group"><label for="address">주소</label><input type="text" id="address" required></div>
                <div id="businessFields" class="business-fields hidden">
                    <h3>사업자 정보</h3>
                    <div class="form-group"><label for="businessNumber">사업자등록번호</label><input type="text" id="businessNumber" placeholder="000-00-00000"></div>
                    <div class="form-group"><label for="businessName">상호명</label><input type="text" id="businessName"></div>
                    <div class="form-group"><label for="businessAddress">사업장 주소</label><input type="text" id="businessAddress"></div>
                    <div class="form-group"><label for="businessPhone">사업장 전화번호</label><input type="tel" id="businessPhone" placeholder="지역번호 포함"></div>
                </div>
                <button type="submit" class="btn btn-success">가입하기</button>
            </form>
        </div>

        <!-- 대시보드 섹션 -->
        <div id="dashboard-section" class="content hidden">
            <!-- 대시보드 탭은 JS에서 동적으로 표시 -->
        </div>

        <div id="loading" class="loading"><div class="spinner"></div><p>처리 중입니다...</p></div>
    </div>

    <script>
        // [설정] - 이 부분을 본인의 Google Apps Script 웹 앱 URL로 변경하세요.
        const GOOGLE_APPS_SCRIPT_URL = 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE';

        // 전역 변수
        let currentUser = null;

        // --- 초기화 및 이벤트 리스너 ---
        document.addEventListener('DOMContentLoaded', () => {
            checkLoginStatus();
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
        });

        // --- 인증 및 사용자 관리 ---
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                updateNav('user');
                showSection('dashboard');
                loadDashboard('orders');
            } else {
                updateNav('guest');
                showSection('home');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            showLoading(true);
            const loginData = {
                action: 'login',
                email: document.getElementById('loginEmail').value,
                password: document.getElementById('loginPassword').value
            };
            const result = await apiCall(loginData);
            if (result.success) {
                currentUser = result.user;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showAlert('login-alert', '로그인 성공!', 'success');
                setTimeout(() => {
                    document.getElementById('loginForm').reset();
                    checkLoginStatus();
                }, 1000);
            } else {
                showAlert('login-alert', result.message, 'error');
            }
            showLoading(false);
        }

        async function handleRegister(e) {
            e.preventDefault();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            if (password !== confirmPassword) {
                showAlert('register-alert', '비밀번호가 일치하지 않습니다.', 'error');
                return;
            }
            showLoading(true);
            const registerData = {
                action: 'register',
                userType: document.getElementById('userType').value,
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                password: password,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                businessNumber: document.getElementById('businessNumber').value,
                businessName: document.getElementById('businessName').value,
                businessAddress: document.getElementById('businessAddress').value,
                businessPhone: document.getElementById('businessPhone').value,
            };
            const result = await apiCall(registerData);
            if (result.success) {
                showAlert('register-alert', '회원가입 성공! 로그인 페이지로 이동합니다.', 'success');
                setTimeout(() => {
                    document.getElementById('registerForm').reset();
                    showSection('login');
                }, 2000);
            } else {
                showAlert('register-alert', result.message, 'error');
            }
            showLoading(false);
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            checkLoginStatus();
        }

        // --- API 통신 ---
        async function apiCall(data) {
            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: 'follow',
                    body: JSON.stringify(data),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                });
                return await response.json();
            } catch (error) {
                console.error('API 호출 오류:', error);
                return { success: false, message: '서버와 통신 중 오류가 발생했습니다.' };
            }
        }

        // --- UI 렌더링 및 제어 ---
        function showSection(sectionName) {
            document.querySelectorAll('.content').forEach(s => s.classList.add('hidden'));
            const section = document.getElementById(`${sectionName}-section`);
            if (section) section.classList.remove('hidden');
        }

        function updateNav(type) {
            document.getElementById('nav-guest').classList.toggle('hidden', type === 'user');
            document.getElementById('nav-user').classList.toggle('hidden', type === 'guest');
        }
        
        function toggleBusinessFields() {
            const userType = document.getElementById('userType').value;
            document.getElementById('businessFields').classList.toggle('hidden', userType !== 'business');
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            loading.style.display = show ? 'flex' : 'none';
        }

        function showAlert(elementId, message, type) {
            const alertDiv = document.getElementById(elementId);
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => { alertDiv.innerHTML = ''; }, 4000);
        }

        // --- 대시보드 관련 함수 ---
        function loadDashboard(activeTab = 'orders') {
            const dashboardSection = document.getElementById('dashboard-section');
            dashboardSection.innerHTML = `<h2>📊 마이페이지: ${currentUser.name}님</h2>`;
            showDashboardTab(activeTab);
        }

        function showDashboardTab(tabName) {
            showSection('dashboard');
            const dashboardSection = document.getElementById('dashboard-section');
            
            // 기존 탭 내용 제거
            const existingTab = dashboardSection.querySelector('.dashboard-tab-content');
            if (existingTab) existingTab.remove();
            
            let tabContent = document.createElement('div');
            tabContent.className = 'dashboard-tab-content';

            if (tabName === 'orders') tabContent.innerHTML = getOrdersHTML();
            else if (tabName === 'profile') tabContent.innerHTML = getProfileHTML();
            else if (tabName === 'newOrder') tabContent.innerHTML = getNewOrderHTML();
            
            dashboardSection.appendChild(tabContent);

            if (tabName === 'orders') loadOrders();
            else if (tabName === 'profile') {
                loadProfile();
                document.getElementById('profileForm').addEventListener('submit', handleProfileUpdate);
            }
            else if (tabName === 'newOrder') {
                document.getElementById('orderForm').addEventListener('submit', handleNewOrder);
            }
        }
        
        function getOrdersHTML() { return `<h3>📦 주문 현황</h3><div id="ordersList"></div>`; }
        function getProfileHTML() { return `<h3>👤 프로필 수정</h3><div id="profile-alert"></div><form id="profileForm"><div class="form-group"><label for="profileName">이름</label><input type="text" id="profileName" required></div><div class="form-group"><label for="profilePhone">휴대폰 번호</label><input type="tel" id="profilePhone" required></div><div class="form-group"><label for="profileAddress">주소</label><input type="text" id="profileAddress" required></div><button type="submit" class="btn btn-primary">수정하기</button></form>`; }
        function getNewOrderHTML() { return `<h3>🛒 새 주문</h3><div class="file-upload-notice"><strong>📧 디자인 파일 안내</strong><br>주문 완료 후 디자인 파일(일러스트 등)을 이메일로 전송해주세요.<br>이메일: youngcardin@hanmail.net</div><div id="order-alert"></div><form id="orderForm"><div class="form-group"><label for="cardType">카드 타입</label><select id="cardType" required><option value="">선택하세요</option><option value="pvc-standard">PVC 표준 (0.76mm)</option><option value="pvc-premium">PVC 프리미엄 (0.84mm)</option><option value="pvc-magnetic">PVC 마그네틱</option></select></div><div class="form-group"><label for="quantity">수량</label><input type="number" id="quantity" min="100" required></div><div class="form-group"><label for="orderNotes">주문 요청사항</label><textarea id="orderNotes" rows="4" placeholder="특별 요청사항이 있으시면 입력해주세요."></textarea></div><button type="submit" class="btn btn-success">주문하기</button></form>`; }

        async function loadOrders() {
            showLoading(true);
            const result = await apiCall({ action: 'getOrders', userId: currentUser.id });
            const ordersList = document.getElementById('ordersList');
            if (result.success && result.orders.length > 0) {
                ordersList.innerHTML = result.orders.map(order => `
                    <div class="status-item">
                        <div>
                            <strong>주문번호: ${order.id}</strong><br>
                            <span>${order.cardType} - ${order.quantity}매</span><br>
                            <small>주문일: ${new Date(order.orderDate).toLocaleDateString()}</small>
                        </div>
                        <div class="status-badge status-${order.status}">
                            ${{pending:'접수 대기', processing:'제작 중', shipping:'배송 중', completed:'완료'}[order.status]}
                        </div>
                    </div>
                `).join('');
            } else {
                ordersList.innerHTML = '<p>주문 내역이 없습니다.</p>';
            }
            showLoading(false);
        }

        function loadProfile() {
            document.getElementById('profileName').value = currentUser.name || '';
            document.getElementById('profilePhone').value = currentUser.phone || '';
            document.getElementById('profileAddress').value = currentUser.address || '';
        }

        async function handleProfileUpdate(e) {
            e.preventDefault();
            showLoading(true);
            const profileData = {
                action: 'updateProfile',
                userId: currentUser.id,
                name: document.getElementById('profileName').value,
                phone: document.getElementById('profilePhone').value,
                address: document.getElementById('profileAddress').value
            };
            const result = await apiCall(profileData);
            if (result.success) {
                currentUser.name = profileData.name;
                currentUser.phone = profileData.phone;
                currentUser.address = profileData.address;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showAlert('profile-alert', '프로필이 수정되었습니다.', 'success');
                loadDashboard('profile'); // 수정된 정보로 대시보드 헤더도 갱신
            } else {
                showAlert('profile-alert', result.message, 'error');
            }
            showLoading(false);
        }

        async function handleNewOrder(e) {
            e.preventDefault();
            showLoading(true);
            const orderData = {
                action: 'newOrder',
                userId: currentUser.id,
                cardType: document.getElementById('cardType').value,
                quantity: parseInt(document.getElementById('quantity').value),
                notes: document.getElementById('orderNotes').value,
            };
            const result = await apiCall(orderData);
            if (result.success) {
                showAlert('order-alert', '주문이 접수되었습니다! 디자인 파일을 이메일로 전송해주세요.', 'success');
                setTimeout(() => showDashboardTab('orders'), 2000);
            } else {
                showAlert('order-alert', result.message, 'error');
            }
            showLoading(false);
        }
    </script>
</body>
</html>
