<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>프리미엄 PVC 카드 주문제작</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap">
    <style>
        :root {
            --primary-color: #0d6efd; --secondary-color: #6c757d; --success-color: #198754;
            --danger-color: #dc3545; --warning-color: #ffc107; --bg-light: #f8f9fa;
            --border-color: #dee2e6; --text-dark: #212529; --text-light: #6c757d;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', sans-serif; margin: 0; background-color: #fff; color: var(--text-dark); line-height: 1.6; }
        .container { max-width: 1140px; margin: 0 auto; padding: 0 15px; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid var(--border-color); }
        .logo { font-size: 1.5rem; font-weight: 700; text-decoration: none; color: var(--text-dark); cursor: pointer; }
        .nav-buttons .btn { margin-left: 0.5rem; }
        .btn { display: inline-block; padding: 0.6rem 1.2rem; font-size: 1rem; font-weight: 500; text-align: center; text-decoration: none; cursor: pointer; border-radius: 0.3rem; transition: all 0.2s; border: 1px solid transparent; }
        .btn-primary { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .btn-primary:hover { background-color: #0b5ed7; }
        .btn-outline-primary { color: var(--primary-color); border-color: var(--primary-color); }
        .btn-outline-primary:hover { background-color: var(--primary-color); color: white; }
        .w-100 { width: 100%; }
        main { padding: 4rem 0; }
        .page-section { display: none; }
        .page-section.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hero { text-align: center; padding: 4rem 0; }
        .hero h1 { font-size: 3rem; font-weight: 700; margin-bottom: 1rem; }
        .hero p { font-size: 1.25rem; color: var(--text-light); margin-bottom: 2rem; max-width: 700px; margin-left: auto; margin-right: auto; }
        .hero .btn { padding: 1rem 2rem; font-size: 1.25rem; }
        .auth-container { max-width: 480px; margin: 2rem auto; padding: 2.5rem; background-color: #fff; border: 1px solid var(--border-color); border-radius: 0.5rem; }
        .auth-container h2 { text-align: center; margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 0.5rem; }
        .form-control { width: 100%; padding: 0.75rem; font-size: 1rem; border: 1px solid var(--border-color); border-radius: 0.3rem; }
        .form-control:focus { outline: 0; border-color: var(--primary-color); box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }
        .alert { padding: 1rem; margin-bottom: 1rem; border: 1px solid transparent; border-radius: 0.3rem; }
        .alert-success { color: #0f5132; background-color: #d1e7dd; border-color: #badbcc; }
        .alert-danger { color: #842029; background-color: #f8d7da; border-color: #f5c2c7; }
        .hidden { display: none; }
        .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading" class="loading hidden"><div class="spinner"></div></div>
    <header class="header container">
        <div class="logo" onclick="showPage('home')">CARD-PRO</div>
        <div id="nav-guest" class="nav-buttons">
            <button class="btn btn-outline-primary" onclick="showPage('login')">로그인</button>
            <button class="btn btn-primary" onclick="showPage('register')">회원가입</button>
        </div>
        <div id="nav-user" class="nav-buttons hidden">
            <span id="user-greeting" style="margin-right: 1rem; align-self: center;"></span>
            <button class="btn btn-primary" onclick="logout()">로그아웃</button>
        </div>
    </header>
    <main class="container" id="main-content"></main>
    <script>
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwbVTXteGOD4aTzmBXrbktgJDu77rhYCtqBdmwoS0D2tN1W7JYhKnnhcrslFOHAf1URpw/exec';
        let currentUser = null;
        const loadingEl = document.getElementById('loading');
        const mainContentEl = document.getElementById('main-content');

        document.addEventListener('DOMContentLoaded', checkLoginStatus);

        async function apiCall(data) {
            showLoading(true);
            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors', // CORS 모드 설정
                    body: JSON.stringify(data),
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) {
                   throw new Error(`HTTP error! status: ${response.status}`);
                }
                const resultText = await response.text();
                // Google Apps Script가 JSON 문자열을 텍스트로 한번 더 감싸서 반환하는 경우가 있음
                return JSON.parse(JSON.parse(resultText)); 
            } catch (error) {
                console.error('API Error:', error);
                showAlert(document.body, '서버 통신 오류. 개발자 콘솔(F12)을 확인하세요.', 'danger');
                return { success: false, message: '서버 통신 오류' };
            } finally {
                showLoading(false);
            }
        }

        function showPage(pageName) {
            if (pageName === 'home') renderHomePage();
            else if (pageName === 'login') renderLoginPage();
            else if (pageName === 'register') renderRegisterPage();
        }

        function updateNav(isLoggedIn) {
            document.getElementById('nav-guest').classList.toggle('hidden', isLoggedIn);
            document.getElementById('nav-user').classList.toggle('hidden', !isLoggedIn);
            if (isLoggedIn) {
                document.getElementById('user-greeting').textContent = `${currentUser.name}님`;
            }
        }
        
        function renderHomePage() {
            mainContentEl.innerHTML = `<div class="page-section active"><div class="hero"><h1>최고의 퀄리티, 당신만의 PVC 카드</h1><p>신분증, 회원카드, 기프트카드 등 모든 종류의 PVC 카드를 전문적으로 제작합니다.</p><button class="btn btn-primary" id="startOrderBtn">견적 / 주문 시작하기</button></div></div>`;
            document.getElementById('startOrderBtn').onclick = () => {
                if (currentUser) {
                    alert("주문 페이지로 이동합니다.");
                } else {
                    renderLoginPage();
                    showAlert('login-alert', '주문을 하시려면 먼저 로그인해주세요.', 'danger');
                }
            };
        }
        function renderLoginPage() {
             mainContentEl.innerHTML = `<div class="page-section active"><div class="auth-container"><h2>로그인</h2><div id="login-alert"></div><form id="loginForm"><div class="form-group"><label for="loginEmail">이메일</label><input type="email" id="loginEmail" class="form-control" required></div><div class="form-group"><label for="loginPassword">비밀번호</label><input type="password" id="loginPassword" class="form-control" required></div><button type="submit" class="btn btn-primary w-100">로그인</button></form></div></div>`;
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
        }
        function renderRegisterPage() {
             mainContentEl.innerHTML = `<div class="page-section active"><div class="auth-container"><h2>회원가입</h2><div id="register-alert"></div><form id="registerForm"><div class="form-group"><label for="userType">회원 유형</label><select id="userType" class="form-control" required><option value="individual">개인</option><option value="business">사업자</option></select></div><div class="form-group"><label for="name">이름</label><input type="text" id="name" class="form-control" required></div><div class="form-group"><label for="email">이메일</label><input type="email" id="email" class="form-control" required></div><div class="form-group"><label for="password">비밀번호</label><input type="password" id="password" class="form-control" required></div><div class="form-group"><label for="confirmPassword">비밀번호 확인</label><input type="password" id="confirmPassword" class="form-control" required></div><div id="businessFields" class="hidden" style="background: #f8f9fa; padding: 1rem; border-radius: 0.3rem;"><h3 style="margin:0 0 1rem;font-size:1.1rem;">사업자 정보</h3><div class="form-group"><label for="businessNumber">사업자등록번호</label><input type="text" id="businessNumber" class="form-control"></div><div class="form-group"><label for="businessName">상호명</label><input type="text" id="businessName" class="form-control"></div></div><button type="submit" class="btn btn-primary w-100">가입하기</button></form></div></div>`;
            document.getElementById('userType').onchange = () => document.getElementById('businessFields').classList.toggle('hidden', document.getElementById('userType').value !== 'business');
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
        }

        function checkLoginStatus() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                updateNav(true);
            } else {
                updateNav(false);
            }
            renderHomePage();
        }

        async function handleLogin(e) {
            e.preventDefault();
            const result = await apiCall({ action: 'login', email: e.target.loginEmail.value, password: e.target.loginPassword.value });
            if (result.success) {
                currentUser = result.user;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                checkLoginStatus();
            } else {
                showAlert('login-alert', result.message, 'danger');
            }
        }
        async function handleRegister(e) {
            e.preventDefault();
            const form = e.target;
            if (form.password.value !== form.confirmPassword.value) {
                showAlert('register-alert', '비밀번호가 일치하지 않습니다.', 'danger'); return;
            }
            const data = { action: 'register', userType: form.userType.value, name: form.name.value, email: form.email.value, password: form.password.value };
            if (form.userType.value === 'business') {
                data.businessNumber = form.businessNumber.value;
                data.businessName = form.businessName.value;
            }
            const result = await apiCall(data);
            if (result.success) {
                renderLoginPage();
                showAlert('login-alert', '회원가입 성공! 이제 로그인해주세요.', 'success');
            } else {
                showAlert('register-alert', result.message, 'danger');
            }
        }
        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            checkLoginStatus();
        }

        function showLoading(show) { loadingEl.classList.toggle('hidden', !show); }
        function showAlert(id, msg, type) {
            const el = document.getElementById(id);
            if(el){
              el.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
              setTimeout(() => { if(el) el.innerHTML = ''; }, 5000);
            } else if (id === document.body) { // 페이지 전체에 대한 경고
              const alertEl = document.createElement('div');
              alertEl.className = `alert alert-${type}`;
              alertEl.style.position = 'fixed';
              alertEl.style.top = '20px';
              alertEl.style.left = '50%';
              alertEl.style.transform = 'translateX(-50%)';
              alertEl.style.zIndex = '10000';
              alertEl.textContent = msg;
              document.body.appendChild(alertEl);
              setTimeout(() => document.body.removeChild(alertEl), 5000);
            }
        }
    </script>
</body>
</html>
