<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 대시보드</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap">
    <style>/* 이전과 동일한 CSS 코드 */</style>
</head>
<body>
    <aside class="sidebar">
        <!-- 이전과 동일한 사이드바 HTML -->
    </aside>

    <main class="main-content">
        <div id="content-area"></div>
    </main>
    
    <!-- 주문 상태 업데이트 모달 (이전과 동일) -->

    <script>
        // --- 설정 ---
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwbVTXteGOD4aTzmBXrbktgJDu77rhYCtqBdmwoS0D2tN1W7JYhKnnhcrslFOHAf1URpw/exec'; // ⚠️ 본인의 웹 앱 URL로 교체!

        document.addEventListener('DOMContentLoaded', () => loadContent('dashboard'));

        // API 호출
        async function apiCall(data) {
            // 로딩 표시 추가 가능
            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST', mode: 'cors', redirect: 'follow',
                    body: JSON.stringify(data),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                });
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                document.getElementById('content-area').innerHTML = `<div class="content-card"><h3>오류</h3><p>서버 통신에 실패했습니다.</p></div>`;
                return { success: false };
            }
        }
        
        // --- 콘텐츠 로딩 및 렌더링 ---
        function loadContent(page) {
            document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));
            document.querySelector(`.sidebar-nav a[onclick*="'${page}'"]`).classList.add('active');
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `<div class="content-card"><p>데이터를 불러오는 중입니다...</p></div>`;

            if (page === 'dashboard') renderDashboardPage();
            else if (page === 'orders') renderOrdersPage();
            else if (page === 'customers') renderCustomersPage();
        }

        async function renderDashboardPage() {
            // 모든 데이터를 한번에 가져옴
            const [orderResult, customerResult] = await Promise.all([
                apiCall({ action: 'getAllOrders' }),
                apiCall({ action: 'getAllCustomers' })
            ]);
            
            if (!orderResult.success || !customerResult.success) return;

            const orders = orderResult.orders || [];
            const customers = customerResult.customers || [];
            const pendingCount = orders.filter(o => o.status === 'pending').length;

            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `
                <div class="page-header"><h1>대시보드</h1></div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-label">총 주문</div><div class="stat-number">${orders.length}</div></div>
                    <div class="stat-card"><div class="stat-label">처리 대기</div><div class="stat-number">${pendingCount}</div></div>
                    <div class="stat-card"><div class="stat-label">총 고객 수</div><div class="stat-number">${customers.length}</div></div>
                </div>
                <div class="content-card">
                    <h2>최근 주문 (5건)</h2>
                    <div class="table-responsive">${renderOrderTable(orders.slice(0, 5))}</div>
                </div>`;
        }

        async function renderOrdersPage() { /* 이전과 유사, 안정화된 코드 */ }
        async function renderCustomersPage() { /* 이전과 유사, 안정화된 코드 */ }
        
        // --- 테이블 렌더링 헬퍼 ---
        function renderOrderTable(orders) {
            if (orders.length === 0) return '<p>주문이 없습니다.</p>';
            let table = `<table><thead><tr><th>주문번호</th><th>고객명</th><th>카드타입</th><th>수량</th><th>상태</th><th>관리</th></tr></thead><tbody>`;
            orders.forEach(o => {
                table += `
                    <tr>
                        <td>${o.id}</td><td>${o.userName || o.userId}</td><td>${o.cardType}</td><td>${o.quantity}</td>
                        <td><span class="status-badge status-${o.status}">${{pending:'대기',processing:'제작중'}[o.status] || o.status}</span></td>
                        <td><button class="btn btn-sm btn-primary" onclick="openUpdateModal('${o.id}', '${o.status}')">수정</button></td>
                    </tr>`;
            });
            table += '</tbody></table>';
            return table;
        }

        // --- 기타 핸들러 및 유틸리티 함수 (이전과 동일) ---
    </script>
</body>
</html>
